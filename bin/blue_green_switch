#!/usr/bin/env ruby

require "aws-sdk-elasticloadbalancingv2"

REGION = "us-west-2".freeze
tg_name = ARGV[0]
color = ARGV[1]
color_port = ARGV[2]

if color_port.nil?
  fail "Cannot detect current color_port. Color_port not passed in cli?"
elsif ["blue", "green"].include?(color)
  puts "Switching to #{color}"
else
  fail "Cannot detect current color. Wrong color passed in cli?"
end

class AWSClient
  class << self
    def elbv2
      @elbv2 ||= Aws::ElasticLoadBalancingV2::Client.new(region: REGION)
    end
  end
end

tg = AWSClient.elbv2.describe_target_groups.target_groups.find { |x| x.target_group_name == tg_name }
targets = AWSClient.elbv2.describe_target_health(target_group_arn: tg.target_group_arn)
                   .target_health_descriptions.map(&:target)

new_targets = []
targets.map(&:id).each do |i|
  new_targets <<
    {
      id: i,
      port: color_port
    }
end

AWSClient.elbv2.register_targets({
  target_group_arn: tg.target_group_arn,
  targets: new_targets
})

AWSClient.elbv2.wait_until(
  :target_in_service,
  target_group_arn: tg.target_group_arn,
  targets: new_targets
)

puts "\n#{color.capitalize} target in service"
puts "De-registering an old one"

AWSClient.elbv2.deregister_targets({
  target_group_arn: tg.target_group_arn,
  targets: targets
})

AWSClient.elbv2.wait_until(
  :target_deregistered,
  target_group_arn: tg.target_group_arn,
  targets: targets
)

puts "\nBlue-green switch completed"
